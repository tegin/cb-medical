<?xml version="1.0"?>

<odoo>

    <record id="paperformat_material" model="report.paperformat">
        <field name="name">Material</field>
        <field name="default" eval="True" />
        <field name="format">A4</field>
        <field name="page_height">0</field>
        <field name="page_width">0</field>
        <field name="orientation">Portrait</field>
        <field name="margin_top">50</field>
        <field name="margin_bottom">23</field>
        <field name="margin_left">7</field>
        <field name="margin_right">7</field>
        <field name="header_line" eval="False" />
        <field name="header_spacing">35</field>
        <field name="dpi">90</field>
    </record>

    <report id="action_agreement_report"
            string="Agreement Report"
            model="medical.coverage.agreement"
            report_type="qweb-pdf"
            name="cb_medical_financial_coverage_agreement.report_agreement_template"
            paperformat="paperformat_material"
        />

    <template id="report_agreement_template_category">
        <t t-set="item" t-value="item_variable"/>
        <tr>
            <td t-att-colspan="min(level, 3)" t-if="level &gt; 0"/>
            <td t-att-colspan="max(7-level, 4)">
                <strong t-esc="'%s - %s' % (item['category'].display_name, item['category'].description)" t-if="item['category'].description"/>
                <strong t-esc="item['category'].display_name" t-else=""/>
            </td>
        </tr>
        <t t-foreach="item['data']" t-as="child">
            <tr>
                <t t-foreach="range(0, min(level, 3) + 1)"  t-as="lvl">
                    <td style="width:20px"/>
                </t>
                <td>
                    <span t-esc="child['product'].default_code" t-if="not child['nomenclature']"/>
                    <span t-esc="'%s [%s]' % (child['nomenclature'].code, child['product'].default_code)" t-if="child['nomenclature']"/>
                </td>
                <td>
                    <span t-esc="child['product'].name"/>
                </td>

                <t t-foreach="range(min(level, 3), 3)" t-as="lvl">
                    <td style="width:20px"/>
                </t>
                <td style="text-align:right"><span t-esc="child['item'].total_price"/></td>
            </tr>
        </t>
        <t t-set="level" t-value="level + 1"/>
        <t t-foreach="item['childs']" t-as="item_variable">
            <t t-call="cb_medical_financial_coverage_agreement.report_agreement_template_category"/>
        </t>
        <t t-set="level" t-value="level - 1"/>
    </template>

    <template id="report_agreement_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <t t-set="agreement" t-value="docs[0]"/>
                    <t t-set="centers" t-value="agreement.center_ids"/>
                    <t t-set="items" t-value="agreement.item_ids"/>
                    <t t-set="data" t-value="o._agreement_report_data()"/>
                    <div class="page">
                        <h3 class="text-center"><span t-field="agreement.name"/></h3>
                        <div class="agreement_details">
                            <h2>
                                <t t-esc="agreement.internal_identifier"/>
                            </h2>
                            <br/>
                            <p><b>Period: </b><span
                                    t-field="agreement.date_from"/>
                                - <span
                                    t-field="agreement.date_to"/></p>
                            </div>
                        <table class="table table-condensed mt32">
                            <tbody>
                                <t t-foreach="data" t-as="item_variable">
                                    <t t-set="level" t-value="0"/>
                                    <t t-call="cb_medical_financial_coverage_agreement.report_agreement_template_category"/>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>
            </t>
        </t>
    </template>

</odoo>
